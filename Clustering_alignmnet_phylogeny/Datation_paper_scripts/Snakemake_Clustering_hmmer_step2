from Bio import SeqIO 
import pandas as pd
import re
import os


# usage example 
#nohup snakemake -j 8000  -s Snakemake_Clustering_hmmer  --cluster "sbatch -J {params.name} -p normal -N 1 --cpus-per-task  {params.threads}  --exclude='pbil-deb33' -o {params.out} -e {params.err}  " &> nohup_Clustering_snakemake.out &
#
#Output clustering directory
Output_cluster_dir="/beegfs/data/bguinet/Cynipoidea_project/Clustering/"
Output_cluster_seqs="/beegfs/data/bguinet/Cynipoidea_project/Clustering/Cluster_seqs"
Output_cluster_ali="/beegfs/data/bguinet/Cynipoidea_project/Clustering/Cluster_alignment"
Output_cluster_hmm="/beegfs/data/bguinet/Cynipoidea_project/Clustering/Cluster_hmmer"

List_clusters=[]
for filename in os.listdir(Output_cluster_seqs):
    if filename.endswith(".aa"):
      List_clusters.append(re.sub('.aa','',filename))


rule all:
        input:
                expand(Output_cluster_ali+"/{cluster}_AA.ali", cluster = List_clusters),
                expand(Output_cluster_hmm+"/{cluster}.hmm", cluster = List_clusters),
                expand(Output_cluster_hmm+"/Hmmer_{cluster}.tab", cluster = List_clusters),
		#Output_cluster_dir+"/NR_homology_All_clusters_AA_result.m8"
                


#Before we need to align all sequences 


#Run clustalo analysis 
rule Clustal_cluster_alignment:
  log: Output_cluster_ali+"/{cluster_number}.log"
  params:
     threads="3",
     time="2:00:00",
     name="Cluster_alignment_{cluster_number}",
     out=Output_cluster_ali+"/Clustal_run_{cluster_number}.out",
     err=Output_cluster_ali+"/Clustal_run_{cluster_number}.error"
  input:
     Cluster_file=Output_cluster_seqs+"/{cluster_number}.aa"
  output:
     Alignment_cluster_file=Output_cluster_ali+"/{cluster_number}_AA.ali",
  shell:
     """
     hostname
     cd {Output_cluster_seqs}
     /beegfs/data/bguinet/TOOLS/clustalo -i {input.Cluster_file} -o {output.Alignment_cluster_file} --threads {params.threads}
     #/beegfs/data/bguinet/TOOLS/mafft-7.505-with-extensions/bin/mafft-ginsi  --maxiterate 1000 --thread {params.threads} {input.Cluster_file} > {output.Alignment_cluster_file}
     """

rule HMMER_and_Clustering:
   params:
      threads="2",
      time="00:40:00",
      name="Clustering_LbFV_family",
      out= Output_cluster_dir+"Hmmer_Clustering_job.out",
      err= Output_cluster_dir+"Hmmer_Clustering_job.error"
   input:
      Cluster_ali=Output_cluster_ali+"/{cluster}_AA.ali",
      Clustering_filtred_output = Output_cluster_dir+"ALL_Predicted_and_known_ORFs_cluster.tab",
      All_known_and_new_viral = Output_cluster_dir+"ALL_Predicted_and_known_ORFs_and_EVEs_and_new.faa"
   output:
      Hmmer_profile=Output_cluster_hmm+"/{cluster}.hmm",
      Hmmer_tab=Output_cluster_hmm+"/Hmmer_{cluster}.tab"
   shell:
      """
      /beegfs/data/bguinet/TOOLS/hmmer-3.3.2/src/hmmbuild {output.Hmmer_profile} {input.Cluster_ali}
      /beegfs/data/bguinet/TOOLS/hmmer-3.3.2/src/hmmsearch --tblout {output.Hmmer_tab} --cpu {params.threads} {output.Hmmer_profile} {input.All_known_and_new_viral}
      """


# run python3 Gather_hmmer_clusters.py -p /beegfs/data/bguinet/Cynipoidea_project/Clustering/Cluster_hmmer -b /beegfs/data/bguinet/Cynipoidea_project/Clustering/ALL_Predicted_and_known_ORFs_cluster.tab

